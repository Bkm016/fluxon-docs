---
title: "@Export 与桥接"
description: "ExportRegistry 如何生成 ClassBridge 并注册扩展函数"
---

`@Export` 将 Java 方法桥接到 Fluxon 扩展函数，避免手写注册逻辑。核心类：`ExportRegistry`, `ExportMethod`, `ClassBridge`, `ExportBytecodeGenerator`（位于 `core/runtime/java`）。

## 快速示例

```java
public final class HashObject {
    public static final HashObject INSTANCE = new HashObject();

    @Export
    public String md5(String input) { ... }
}

FluxonRuntime runtime = FluxonRuntime.getInstance();
runtime.getExportRegistry().registerClass(HashObject.class, "fs:crypto");
```

注册后即可在脚本中调用 `hash::md5("text")`，命名空间 `fs:crypto` 会自动附加。

## 注册流程

1. `registerClass(clazz, namespace)` 扫描 `@Export` 方法。
2. 方法名经 `StringUtils.transformMethodName` 去除 `get` 前缀（`getNow` -> `now`）。
3. `ExportBytecodeGenerator.generateClassBridge` 生成无反射的 `ClassBridge`。
4. 参数处理：`@Optional` 生成多种 `paramCount`；`ExportMethod` 记录异步/主线程标记（可扩展）。
5. 按属性调用 `registerExtensionFunction` / `registerAsyncExtensionFunction` / `registerSyncExtensionFunction` 完成注册。

## 签名与类型校验

- 调用前使用 `Intrinsics.checkArgumentTypes` 验证实参类型，确保与 Java 方法兼容。
- 返回值直接透传到脚本，如需转换可在方法内使用 `Coerce`。

## 仅注册部分方法

```java
Method method = HashObject.class.getDeclaredMethod("md5", String.class);
ExportMethod exportMethod = new ExportMethod(method, "md5");
runtime.getExportRegistry().registerClassMethods(HashObject.class, "fs:crypto", new ExportMethod[]{exportMethod});
```

适用于重命名或混合同步/异步方法的场景。

## 调试清单

- `FluxonRuntime#getExtensionFunctions()`：查看类到扩展函数的映射。
- 新增 `@Export` 未生效时检查：是否重新注册并重跑 `dumpFluxonCatalog`；方法名是否被改写；是否缺少 `@Optional` 导致参数计数不匹配。

通过桥接流程，可以快速把现有 Java 工具类包装为 Fluxon 内置或扩展函数。
